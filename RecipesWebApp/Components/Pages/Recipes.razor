@page "/recipes"
@using RecipesAPI.Models
@using RecipesWebApp.Services
@inject RecipeService RecipeService
@inject NavigationManager Navigation

<PageTitle>Database for opskrifter</PageTitle>

<div class="container mt-4">
    <h3 class="mb-4">Opskrifter (database)</h3>

    @if (recipes is null)
    {
        <div class="alert alert-info">Indlæser opskrifter...</div>
    }
    else
    {
        <button class="btn btn-success mb-4 shadow-sm" @onclick="GoToCreate">
            <i class="bi bi-plus-circle me-1"></i> Opret ny opskrift
        </button>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var recipe in recipes)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <a href="/recipe/@recipe.Id" class="text-decoration-none text-dark">
                            <img src="@recipe.ImageUrl" class="card-img-top" style="object-fit: cover; height: 200px;" alt="@recipe.Title" />
                        </a>

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@recipe.Title</h5>
                            <p class="card-text text-muted" style="max-height: 4.5em; overflow: hidden;">
                                @recipe.Description
                            </p>

                            <span class="badge rounded-pill bg-info text-dark align-self-start">@recipe.PreparationTime min</span>

                            <p class="mb-1"><strong>Måltid:</strong> @recipe.Category</p>
                            <p class="mb-1"><strong>Cuisine:</strong> @recipe.CuisineType</p>

                            <div style="max-height: 100px; overflow-y: auto;">
                                <strong>Ingredienser:</strong>
                                <ul class="mb-2 ps-3">
                                    @foreach (var ingredient in recipe.Ingredients)
                                    {
                                        <li>@ingredient</li>
                                    }
                                </ul>
                            </div>

                            <div class="mt-auto d-flex gap-2">
                                <button class="btn btn-warning btn-sm w-100" @onclick="() => EditRecipe(recipe.Id)">Rediger</button>
                                <button class="btn btn-danger btn-sm w-100" @onclick="() => ConfirmDelete(recipe.Id, recipe.Title)">Slet</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showConfirm)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bekræft sletning</h5>
                    <button type="button" class="btn-close" @onclick="() => showConfirm = false"></button>
                </div>
                <div class="modal-body">
                    <p>Er du sikker på, at du vil slette <strong>@recipeTitleToDelete</strong>?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => showConfirm = false">Annuller</button>
                    <button class="btn btn-danger" @onclick="DeleteConfirmed">Slet</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Recipe>? recipes;

    private bool showConfirm = false;
    private int recipeIdToDelete;
    private string recipeTitleToDelete = "";

    protected override async Task OnInitializedAsync()
    {
        recipes = await RecipeService.GetRecipesAsync();
    }

    private void GoToCreate() => Navigation.NavigateTo("/create-recipe");

    private void EditRecipe(int id) => Navigation.NavigateTo($"/edit-recipe/{id}");

    private void ConfirmDelete(int id, string title)
    {
        recipeIdToDelete = id;
        recipeTitleToDelete = title;
        showConfirm = true;
    }

    private async Task DeleteConfirmed()
    {
        await RecipeService.DeleteRecipeAsync(recipeIdToDelete);
        recipes = await RecipeService.GetRecipesAsync();
        showConfirm = false;
    }

    // private async Task DeleteRecipe(int id)
    // {
    //     await RecipeService.DeleteRecipeAsync(id);
    //     recipes = await RecipeService.GetRecipesAsync();
    // }
}
